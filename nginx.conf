# =============================================================================
# Nginx Configuration for React SPA (Single Page Application)
# =============================================================================

# Optimize for containers (use 1 worker per available CPU core)
worker_processes auto;

# Handle more concurrent connections in containers
events {
    worker_connections 1024;
}

http {
    # Include MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

server {
    # =========================================================================
    # 1. LISTENING PORTS
    # =========================================================================

    listen 80;
    # Listen on port 80 for IPv4 traffic
    # This is the standard HTTP port

    listen [::]:80;
    # Listen on port 80 for IPv6 traffic
    # [::] is IPv6 notation for "all addresses"

    server_name _;
    # Server name (domain)
    # _ means "match any domain"
    # In production, use: server_name myapp.com www.myapp.com;
    
    # =========================================================================
    # 2. ROOT DIRECTORY AND INDEX
    # =========================================================================
    
    root /usr/share/nginx/html;
    # Document root - where nginx looks for files
    # This is where we copied our React build files
    
    index index.html;
    # Default file to serve when directory is requested
    # When accessing /, nginx serves /usr/share/nginx/html/index.html

    # =========================================================================
    # 3. GZIP COMPRESSION (Make files smaller for faster transfer)
    # =========================================================================
    
    gzip on;
    # Enable gzip compression
    
    gzip_vary on;
    # Add "Vary: Accept-Encoding" header
    # Tells caching proxies to cache both compressed and uncompressed versions
    
    gzip_min_length 1024;
    # Only compress files larger than 1KB
    # Small files aren't worth compressing (overhead > savings)
    
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json
               image/svg+xml;
    # File types to compress
    # Note: HTML is always compressed (don't need to specify)
    # Don't compress images (jpg, png) - already compressed!

    # =========================================================================
    # 4. SECURITY HEADERS (2025 Best Practices)
    # =========================================================================

    # Content Security Policy (CSP) - Modern XSS/injection protection
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self';" always;
    # CSP restricts resource loading to prevent XSS and injection attacks
    # Adjust script-src and style-src based on your app's needs

    add_header X-Frame-Options "SAMEORIGIN" always;
    # Prevents clickjacking attacks
    # SAMEORIGIN = page can only be embedded in frames from same origin

    add_header X-Content-Type-Options "nosniff" always;
    # Prevents MIME type sniffing
    # Forces browser to respect Content-Type header

    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    # Controls how much referrer information to send
    # strict-origin-when-cross-origin = send origin only when protocol security is same or improved

    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    # Restrict browser features and APIs

    # =========================================================================
    # 5. CACHE STATIC ASSETS (Images, CSS, JS files)
    # =========================================================================
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # ~* = case-insensitive regex match
        # Matches files ending with these extensions
        
        expires 1y;
        # Cache for 1 year
        # Tells browser to keep file for 1 year
        
        add_header Cache-Control "public, immutable";
        # public = can be cached by any cache (browser, CDN)
        # immutable = file never changes, don't revalidate
    }

    # =========================================================================
    # 6. DON'T CACHE INDEX.HTML (Important for React SPA!)
    # =========================================================================
    
    location = /index.html {
        # = means exact match only
        # Only matches /index.html, not /index.html/something
        
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        # no-cache = always check with server before using cached version
        # no-store = don't store in cache at all
        # must-revalidate = must check with server if cache expired
        
        expires 0;
        # Expire immediately
    }

    # =========================================================================
    # 7. API PROXY (Optional - Uncomment if you have backend API)
    # =========================================================================
    #
    # IMPORTANT: This section is commented out by default
    # Uncomment and configure if you need to proxy API requests to a backend
    #
    # location /api {
    #     # Any request to /api/* gets proxied to backend
    #
    #     proxy_pass http://api:3000;
    #     # Forward request to backend service (Docker service name: api)
    #     # Replace with your actual backend URL/service
    #
    #     proxy_http_version 1.1;
    #     # Use HTTP/1.1 (needed for WebSockets)
    #
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection 'upgrade';
    #     # Support WebSocket connections
    #
    #     proxy_set_header Host $host;
    #     # Forward original Host header to backend
    #
    #     proxy_cache_bypass $http_upgrade;
    #     # Don't cache WebSocket connections
    #
    #     proxy_set_header X-Real-IP $remote_addr;
    #     # Send client's real IP address to backend
    #
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     # Add client IP to X-Forwarded-For chain
    # }

    # =========================================================================
    # 8. REACT ROUTER (SPA) - Most Important for React!
    # =========================================================================
    
    location / {
        try_files $uri $uri/ /index.html;
        # This is the magic that makes React Router work!
    }

    # =========================================================================
    # 9. HEALTH CHECK ENDPOINT
    # =========================================================================
    
    location /health {
        access_log off;
        # Don't log health check requests (reduces log noise)
        
        return 200 "healthy\n";
        # Return HTTP 200 with body "healthy"
        
        add_header Content-Type text/plain;
        # Set content type to plain text
    }
}
}